{{define "item"}}
{{template "header"}}

<!-- Kladr api -->
<link rel="stylesheet"
      href="/css/jquery.kladr.min.css">

<script type="text/javascript"
        src="/js/kladr/jquery.kladr.min.js"></script>

<script type="text/javascript"
        src="/js/kladr/kladr.js"></script>

<div>
    <div id="history">
        <h5>Ранее заполненные анкеты</h5>
        <form>
            <select id="h-events" name="h-events"></select>
            <input type="button" value="выбрать" id="send-btn" name="submit"/>
        </form>
    </div>

    <div id="now">
        <div id="server-answer"></div>
        <form>
            <h1 id="event" href="#events"></h1>
            <div id="events"></div>
            <input type="button" value="сохранить" id="save-btn" name="submit"/>
        </form>
    </div>
</div>

<script type="text/javascript">
require(["utils", "datepicker/datepicker"],
function(utils, datepicker) {
    var valid = false;

    var D = {{.}};

    var E = D.E;
    var F = D.F;
    var P = D.P;

    var F_ids = {};

    function drawParam(data, event_type_id, for_saving) {
        var block;

        if (data["type"] === "region"
            || data["type"] === "district"
            || data["type"] === "city"
            || data["type"] === "street"
            || data["type"] === "building"
            || data["type"] === "text"
            || data["type"] === "password"
            || data["type"] === "phon") {
            block = $("<input/>", {type: data["type"]});
            block.attr("id", data["id"]);
            block.attr("event_type_id", event_type_id);
            block.val(data["value"]);
            block.attr("for-saving", for_saving);

        } else if (data["type"] === "textarea") {
            block = $("<textarea/>", {});
            block.attr("id", data["id"]);
            block.attr("event_type_id", event_type_id);
            block.val(data["value"]);
            block.attr("for-saving", for_saving);

        } else if (data["type"] === "date") {
            block = $("<input/>", {type: "date"});
            block.attr("id", data["id"]);
            block.attr("event_type_id", event_type_id);
            block.attr("for-saving", for_saving);
            block.val(data["value"]);
            datepicker.initDatePicker(block);
        }

        var lable = $("<label/>", {
            text: data["name"]
        });

        return $("<p/>").append(lable).append(block);
    }

    function getFormData(name) {
        var values = [];

        var $obj = $("#now form #events [for-saving=true]");
        $obj.each(function() {
            values.push({
                "value": $(this).val(),
                "id": $(this).attr("id"),
                "event_type_id": $(this).attr("event_type_id"),
            });
        });

        return values;
    }

    function pushFormData(E, F, P, event_, events_) {
        console.log("E")
        console.log(E)
        console.log("F")
        console.log(F)
        console.log("P")
        console.log(P)

        $("#" + event_).text(E[0]["name"]);

        var div_forms = $("<div/>", {id: "event-" + E[0]["id"]});
        var ul_forms = $("<ul/>", {});

        $(div_forms).append(ul_forms);
        $(div_forms).appendTo("#" + events_);

        F_ids["form_id"] = []

        for (var i = 0; i < F.length; ++i) {

            var li_form = $("<li/>", {});
            var a_form = $("<a/>", {href: "#" + "form-" + F[i]["id"]}).text(F[i]["name"]);

            $(li_form).append(a_form);
            $(ul_forms).append(li_form);

            var div_tab_form = $("<div/>", {id: "form-" + F[i]["id"]});
            $(div_forms).append(div_tab_form);

            F_ids["form_id"].push(parseInt(F[i]["id"]));

            var div_params = $("<div/>", {id: "params-" + F[i]["id"]});
            $(div_tab_form).append(div_params);

            var table = $("<table/>");
            div_params.append(table);

            for (var k = 0; k < P[i].length; k++) {
                var tr = $("<tr/>").appendTo(table);
                var td_1 = $("<td/>").appendTo(tr);
                $(td_1).append(drawParam(P[i][k], F[i]["id"], true));
                tr.append($("<td/>", {id: "export-param-"+P[i][k]["id"]}));
                tr.append($("<td/>", {id: "export-val-"+P[i][k]["id"]}));
            }
        }

        $("#" + "event-" + E[0]["id"]).tabs();
    }

    function getListHistoryEvents() {
        utils.postRequest(
            {
                "form_ids": F_ids,
            },
            function(response) {
                if (response["result"] !== "ok" && response["result"] !== "no") {
                    console.log("getListHistoryEvents: ", response["result"]);
                    $("#history").css("visibility", "hidden");
                }

                if (response["data"]) {
                    var data = response["data"];
                    for (var i = 0; i < data.length; ++i) {
                        $("#h-events").append($("<option></option>")
                            .attr("value", data[i]["id"])
                            .text(data[i]["name"])
                        );
                    }
                }
            },
            "/handler/getlisthistoryevents"
        );
    }

    pushFormData(E, F, P, "event", "events");
    getListHistoryEvents();
    kladr();

    $("input#2").blur(function() {
        var pattern = /^.{6,36}$/;
        if (pattern.test($(this).val())) {
            $(this).css({"border": "2px solid green"});
        } else {
            valid = false;
            $(this).css({"border": "2px solid red"});
        }
    });

    $("input#3").blur(function() {
        var pattern = /^.{6,36}$/;
        if (pattern.test($(this).val()) && $(this).val() === $("input#2").val()) {
            valid = true;
            $(this).css({"border": "2px solid green"});
        } else {
            valid = false;
            $(this).css({"border": "2px solid red"});
        }
    });

    $("#save-btn").click(function() {
        if (!valid && E[0]["id"] == 1) {
            return;
        }

        utils.postRequest(
            {
                "event_id": parseInt(E[0]["id"]),
                "data": getFormData("now")
            },
            function(data) {
                $("#now form").css("visibility", "hidden");
                if (data["result"] === "ok") {
                    $("#now #server-answer").text("Запрос успешно выполнен.").css("color", "green");

                } else if (data.result === "loginExists") {
                    $("#now #server-answer").text("Такой логин уже существует.").css("color", "red");

                } else if (data.result === "badLogin") {
                    $("#now #server-answer").text("Логин может содержать буквы и/или "
                        + "цифры и иметь длину от 2 до 36 символов.").css("color", "red");

                } else if (data.result === "badPassword") {
                    $("#now #server-answer").text("Пароль должен иметь длину от 6 "
                        + "до 36 символов.").css("color", "red");

                } else if (data.result === "alreadyFilled") {
                    $("#now #server-answer").text("Анкета уже была заполнена.").css("color", "red");

                } else if (data.result === "notAuthorized") {
                    $("#now #server-answer").text("Пользователь не авторизован.").css("color", "red");

                } else if (data.result === "authorized") {
                    $("#now #server-answer").text("Пользователь уже авторизован.").css("color", "red");

                } else {
                    $("#now #server-answer").text(data["result"]).css("color", "red");
                }
                $("div #history").hide();
            },
            "/handler/saveuserrequest"
        );
    });

    $("#send-btn").click(function() {
        utils.postRequest(
            {
                "event_id": $("#h-events").find(":selected").attr("value")
            },
            function(response) {
                if (response["result"] === "notAuthorized") {
                    $("#server-answer").text("Пользователь не авторизован.").css("color", "red");
                    return;
                }

                var data = response["data"];

                for (var i = 0; i < data.length; ++i) {

                    var f_id = data[i]["form_id"];
                    var p_id = data[i]["param_id"];
                    var p_v = data[i]["value"];

                    $("#params-"+f_id +" table #export-param-"+p_id+" input").remove();
                    $("#params-"+f_id +" table #export-val-"+p_id+" p").remove();
                    if (data[i]["value"] != "") {
                        $("#params-"+f_id +" table #export-val-"+p_id).append(drawParam(data[i], 0, false));

                        $("<input/>", {
                            "id": "export-btn-"+f_id+"-"+p_id,
                            "type": "button",
                            "value": "экспорт",
                            "data-event-type-id": f_id,
                            "data-param-id": p_id,
                            "data-param-val": p_v,
                        }).appendTo("#params-"+f_id+" table #export-param-"+p_id);

                        $("#export-btn-"+f_id+"-"+p_id).click(function() {
                            var f_id = $(this).attr("data-event-type-id");
                            var p_id = $(this).attr("data-param-id");
                            var p_v = $(this).attr("data-param-val");
                            $("#params-"+f_id+" table #"+p_id).val(p_v);
                        });
                    }
                }
            },
            "/handler/gethistoryrequest"
        );
    });
});

</script>

{{template "footer"}}
{{end}}
