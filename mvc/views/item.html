{{define "item"}}
{{template "header"}}

<link rel="stylesheet"
      href="/css/jquery.kladr.min.css">

<script type="text/javascript"
        src="/js/kladr/jquery.kladr.min.js"></script>

<div id="container">
    <div id="now">
        <div id="server-answer"></div>
        <form id="form-event"></form>
    </div>
</div>

<script type="text/javascript">
require(["utils", "kladr/kladr", "blank"],
function(utils, kladr, blank) {
    var valid = false;

    blank.getListHistoryEvents("history", blank.ShowBlank({{.}}.data, "form-event"));
    kladr.kladr();
    $("#now").append($("<input/>", {
        type: "button",
        value: "отправить запрос",
        id: "save-btn",
        name: "submit"
    }));

    $("input#2").blur(function() {
        var pattern = /^.{6,36}$/;
        if (pattern.test($(this).val())) {
            $(this).css({"border": "2px solid green"});
        } else {
            valid = false;
            $(this).css({"border": "2px solid red"});
        }
    });

    $("input#3").blur(function() {
        var pattern = /^.{6,36}$/;
        if (pattern.test($(this).val()) && $(this).val() === $("input#2").val()) {
            valid = true;
            $(this).css({"border": "2px solid green"});
        } else {
            valid = false;
            $(this).css({"border": "2px solid red"});
        }
    });

    $("#save-btn").click(function() {

        var event_id = {{.}}.data[0]["event_id"];

        if (!valid && event_id == 1) {
            $("#now #server-answer").text("Логин может содержать латинские буквы и/или "
                + "цифры и иметь длину от 2 до 36 символов.").css("color", "red");
            return;
        }

        var data = blank.getFormData("now form div");
        if (data == false) {
            alert("Не все поля заполнены.");
            return;
        }

        var js = { "event_id": parseInt(event_id), "data": data};
        console.log("save-btn: ", js);

        utils.postRequest(
            js,
            function(data) {
                if (data["result"] == "ok") {
                    $("#now form").hide();
                    $("div #history").hide();
                }
                blank.ShowServerAns(event_id, data, "now #server-answer");
            },
            "/handler/saveuserrequest/"+{{.}}.token
        );
    });
});

</script>

{{template "footer"}}
{{end}}
