{{define "item"}}
{{template "header"}}

<link rel="stylesheet"
      href="/css/jquery.kladr.min.css">

<script type="text/javascript"
        src="/js/kladr/jquery.kladr.min.js"></script>

<div id="container">
    <div id="now">
        <div id="server-answer"></div>
        <form id="form-event"></form>
    </div>
</div>

<script type="text/javascript">
require(["utils", "kladr/kladr", "blank", "grid-utils"],
function(utils, kladr, blank, gridUtils) {
    var valid = false;

    blank.getListHistoryEvents("history", blank.ShowBlank({{.}}.data, "form-event"));
    kladr.kladr();
    $("#now").append($("<input/>", {
        type: "button",
        value: "отправить запрос",
        id: "save-btn",
        name: "submit"
    }));

    $("input#1").blur(function() {
        var pattern = /^[a-zA-Z0-9]{2,36}$/;
        if (!pattern.test($(this).val())) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            gridUtils.showServerPromtInDialog( $(this).parent(), "Логин может содержать латинские буквы и/или "
                + "цифры и иметь длину от 2 до 36 символов.");

        } else {
            valid = true;
            $(this).css({"border": "2px solid green"});
        }
    });

    $("input#2").blur(function() {
        var pattern = /^.{6,36}$/;
        if (!pattern.test($(this).val())) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            gridUtils.showServerPromtInDialog( $(this).parent(), "Пароль должен иметь длину от 6 до 36 символов.");

        } else {
            valid = true;
            $(this).css({"border": "2px solid green"});
        }
    });

    $("input#3").blur(function() {
        var pattern = /^.{6,36}$/;

        if (!pattern.test($(this).val())) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            gridUtils.showServerPromtInDialog( $(this).parent(), "Пароль должен иметь длину от 6 до 36 символов.");
            return;
        }

        if ($(this).val() !== $("input#2").val()) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            gridUtils.showServerPromtInDialog( $(this).parent(), "Пароли не совпадают.");
            return;
        }

        valid = true;
        $(this).css({"border": "2px solid green"});
    });

    $("#save-btn").click(function() {

        var event_id = {{.}}.data[0]["event_id"];

        if (!valid && event_id == 1) {
            $("#now #server-answer").text("Проверьте данные о логине и пароле.").css("color", "red");
            return;
        }

        var data = blank.getFormData("now form div");
        if (data == false) {
            alert("Не все поля заполнены.");
            return;
        }

        var js = { "event_id": parseInt(event_id), "data": data};
        console.log("save-btn: ", js);

        utils.postRequest(
            js,
            function(data) {
                if (data["result"] == "ok") {
                    $("#now form").hide();
                    $("#now #save-btn").hide();
                    $("div #history").hide();
                }
                blank.ShowServerAns(event_id, data, "now #server-answer");
            },
            "/handler/regperson/"
        );
    });
});

</script>

{{template "footer"}}
{{end}}
