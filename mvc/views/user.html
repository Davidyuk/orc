{{define "user"}}
{{template "header"}}

<link rel="stylesheet"
      href="/css/jquery.kladr.min.css">

<script type="text/javascript"
        src="/js/kladr/jquery.kladr.min.js"></script>

<div id="container">

    <div id="title" class="left"></div></br>

    <div id="cabinet" class="left">
        <div hidden="true" id="dialog-reg-group" title="Регистрация группы"></div>
        <div hidden="true" id="dialog-person-request" title="Анкета"></div>
        <div hidden="true" id="dialog-group-person-request" title="Анкета"></div>
        <div id="error"></div>
        <p id="userData"></p>

        <div id="tabs">
            <ul>
                <li><a href="#tabs-1">Группы</a></li>
                <li><a href="#tabs-2">Индивидуальные регистрации</a></li>
                <li><a href="#tabs-3">Регистрации групп</a></li>
                <li><a href="#tabs-4">Смена пароля</a></li>
            </ul>

            <div id="tabs-1">
                <p>
                    <table id="my-group-table"></table>
                    <div id="my-group-table-pager"></div>
                </p>
                <p>
                    <table id="group-table"></table>
                    <div id="group-table-pager"></div>
                </p>
            </div>
            <div id="tabs-2">
                <p>
                    <table id="reg-table"></table>
                    <div id="reg-table-pager"></div>
                </p>
            </div>

            <div id="tabs-3">
                <p>
                    <table id="groupreg-table"></table>
                    <div id="groupreg-table-pager"></div>
                </p>
            </div>

            <div id="tabs-4">
                <div id="dialog-reset-pass" style="width:200px;">
                    <form>
                        <p>
                            <label for="password-1">Пароль</label>
                            <input type="password" id="password-1" name="password-1"/>
                        </p>
                        <p>
                            <label for="password-2">Потвердите пароль</label>
                            <input type="password" id="password-2" name="password-2"/>
                        </p>
                        <p><input type="button" id="reset-btn" value="сохранить"/></p>
                    </form>
                </div>
            </div>
        </div>

    </div>

</div>

<script type="text/javascript">

$("#title").append("Личный кабинет");

$(function() {
    $("#tabs").tabs();
});

require(["grid-utils", "custom-grid", "reg-group", "blank", "utils", "reset-pass", "utils"],
function(utils, grid, regGroup, blank, req, resetPass, reqUtils) {

    var valid = false;
    console.log({{.}});

    $("#password-1").blur(function() {
        var pattern = /^.{6,36}$/;
        if (!pattern.test($(this).val())) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            utils.showServerPromtInDialog( $(this).parent(), "Пароль должен иметь длину от 6 до 36 символов.");

        } else {
            valid = true;
            $(this).css({"border": "2px solid green"});
        }
    });

    $("#password-2").blur(function() {
        var pattern = /^.{6,36}$/;

        if (!pattern.test($(this).val())) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            utils.showServerPromtInDialog( $(this).parent(), "Пароль должен иметь длину от 6 до 36 символов.");
            return;
        }

        if ($(this).val() !== $("#password-1").val()) {
            valid = false;
            $(this).css({"border": "2px solid red"});
            utils.showServerPromtInDialog( $(this).parent(), "Пароли не совпадают.");
            return;
        }

        valid = true;
        $(this).css({"border": "2px solid green"});
    });

    $("#reset-btn").click(function() {
        if (!valid) {
            $("#error").text("Проверьте данные о логине и пароле.").css("color", "red");
            return;
        }

        var result = resetPass.CheckPass("password-1", "password-2");
        if (!result.result) {
            utils.showErrorMsg(result.msg);
            return false;
        }
        reqUtils.postRequest(
            { "pass": $("#password-1").val() },
            function(data) { utils.showServerPromtInDialog($("#dialog-reset-pass"), data["result"]); },
            "/handler/resetpassword"
        );
    })

    $("#userData").append($("<div/>").text("Логин: "+{{.}}.userData[0].login));
    $("#userData").append($("<div/>").text({{.}}.userData[0].name+": "+{{.}}.userData[0].value));

    $("#my-group-table").jqGrid({
        url: "/handler/usergroupsload",
        datatype: "json",
        mtype: "POST",
        treeGrid: false,
        colNames: {{.group.ColNames}},
        colModel: grid.SetPrimitive({{.group.ColModel}}),
        pager: "#my-group-table-pager",
        gridview: true,
        sortname: "id",
        viewrecords: true,
        height: "100%",
        width: "auto",
        rowNum: 5,
        rownumbers: true,
        rownumWidth: 20,
        rowList: [5, 10, 20, 50],
        caption: "Мои группы",
        sortname: "id",
        sortorder: "asc",
        editurl: "/gridhandler/editgridrow/" + {{.group.TableName}},
        multiselect: true,
        loadError: function (jqXHR, textStatus, errorThrown) {
            alert('HTTP status code: ' + jqXHR.status + '\n'
                + 'textStatus: ' + textStatus + '\n'
                + 'errorThrown: ' + errorThrown);
            alert('HTTP message body: ' + jqXHR.responseText);
        },

        subGrid: {{.group.Sub}},
        subGridOptions: {
            "plusicon": "ui-icon-triangle-1-e",
            "minusicon": "ui-icon-triangle-1-s",
            "openicon": "ui-icon-arrowreturn-1-e",
            "reloadOnExpand": true,
            "selectOnExpand": true
        },
        subGridRowExpanded: function(subgrid_id, group_id) {
            $("#" + subgrid_id).append("<table id='" + subgrid_id + "_t" + "' class='scroll'></table>"
                + "<div id='" + subgrid_id + "_p" + "' class='scroll'></div></br>");

            var addDelFlag = false;
            reqUtils.postRequest(
                { "group_id": group_id },
                function(data) {
                    console.log("Is Reg Group?");
                    console.log(data["result"]);
                    addDelFlag = data["addDelFlag"];
                },
                "/gridhandler/isreggroup"
            );

            $("#" + subgrid_id + "_t").jqGrid({
                url: "/handler/"+{{.group.SubTableName}}.replace(/_/g, "")+"load/"+group_id,
                datatype: "json",
                mtype: "POST",
                colNames: {{.group.SubColNames}},
                colModel: grid.SetPrimitive({{.group.SubColModel}}),
                rowNum: 5,
                rowList: [5, 10, 20, 50],
                pager: "#" + subgrid_id + "_p",
                caption: {{.group.SubCaption}},
                sortname: "num",
                sortorder: "asc",
                height: "100%",
                width: $("#my-group-table").width()-65,
                editurl: "/gridhandler/editgridrow/"+{{.group.SubTableName}},
                loadError: function(jqXHR, textStatus, errorThrown) {
                    alert('HTTP status code: ' + jqXHR.status + '\n'
                        + 'textStatus: ' + textStatus + '\n'
                        + 'errorThrown: ' + errorThrown);
                    alert('HTTP message body: ' + jqXHR.responseText);
                },
                gridComplete: function() {
                    var rows = $("#"+subgrid_id + "_t").getDataIDs();
                    for (var i = 0; i < rows.length; i++) {
                        var status = $("#"+subgrid_id + "_t").getCell(rows[i], "status");
                        console.log(status)
                        if (status === "true") {
                            $("#"+subgrid_id + "_t").jqGrid('setRowData', rows[i], false, "row-green");
                        }
                    }
                },
            });

            $("#"+subgrid_id + "_t").navGrid(
                "#"+subgrid_id + "_p",
                {   //buttons
                    edit: true,
                    add: addDelFlag,
                    del: addDelFlag,
                    view: true,
                    search: false,
                    refresh: false,
                },
                {   //edit
                    width: "100%",
                    recreateForm: true,
                    afterSubmit: function(data) { return utils.errTextFormat(data, subgrid_id + "_t"); },
                    errorTextFormat: function(data) { return utils.errTextFormat(data, subgrid_id + "_t"); },
                    beforeShowForm: function(form) {
                        $("#tr_status", form).hide();
                        $("#" + subgrid_id + "_t").jqGrid("getColProp", "status").editable = false;
                    },
                    afterShowForm: utils.resizeSelectWidth,
                },
                {   //add
                    width: "100%",
                    recreateForm: true,
                    addedrow: "last",
                    afterSubmit: function(data) { return utils.errTextFormat(data, subgrid_id + "_t"); },
                    errorTextFormat: function(data) { return utils.errTextFormat(data, subgrid_id + "_t"); },
                    beforeShowForm: function(form) {
                        $("#tr_status", form).hide();
                        $("#" + subgrid_id + "_t").jqGrid("getColProp", "status").editable = false;
                    },
                    afterShowForm: utils.resizeSelectWidth,
                    afterShowForm: function(formId) {
                        var faseTd2 = $($($('#tr_face_id', formId)[0]).children()[1]);
                        var ansSelect = $(faseTd2.find('select'));

                        ansSelect.empty();

                        var tr1 = $('<tr class="FormData" id="tr_AddInfoForChoosingParams">'
                            +'<td class="CaptionTD ui-widget-content">'
                            +'<p><b>Выберите параметры поиска:</b></p>'
                            +'</td></tr>').insertAfter($('#tr_face_id', formId).show());
                        var tdParams = $('<td><p>'
                            +'<table id="params-table"></table>'
                            +'<div id="params-table-pager"></div>'
                            +'</p></td>').appendTo(tr1);
                        var tr2 = $('<tr class="FormData" id="tr_AddInfoForChoosingFace">'
                            +'<td class="CaptionTD ui-widget-content">'
                            +'<p><b>Выберите участника:</b></p>'
                            +'</td></tr>').insertAfter($('#tr_AddInfoForChoosingParams', formId).show());
                        var tdFaces = $('<td><p>'
                            +'<table id="faces-table"></table>'
                            +'<div id="faces-table-pager"></div>'
                            +'</p></td>').appendTo(tr2);

                        var filter = {};

                        $("#params-table").jqGrid({
                            url: "/gridhandler/load/"+{{.params.TableName}},
                            datatype: "json",
                            mtype: "POST",
                            treeGrid: false,
                            colNames: {{.params.ColNames}},
                            colModel: grid.SetPrimitive({{.params.ColModel}}),
                            pager: "#params-table-pager",
                            gridview: true,
                            viewrecords: true,
                            height: "100%",
                            width: "auto",
                            rowNum: 1,
                            rownumbers: true,
                            rownumWidth: 20,
                            rowList: [5, 10, 20, 50],
                            caption: {{.params.Caption}},
                            sortname: "id",
                            sortorder: "asc",
                            loadError: function (jqXHR, textStatus, errorThrown) {
                                alert('HTTP status code: ' + jqXHR.status + '\n'
                                    + 'textStatus: ' + textStatus + '\n'
                                    + 'errorThrown: ' + errorThrown);
                                alert('HTTP message body (jqXHR.responseText): ' + '\n' + jqXHR.responseText);
                            },
                            loadComplete: function() {
                                $("#faces-table").trigger('reloadGrid')
                            },
                            beforeRequest: function() {
                                filter = $("#params-table").getGridParam("postData").filters;
                            }
                        });

                        $("#params-table").jqGrid("hideCol", ["id"]);
                        $("#params-table").jqGrid("hideCol", ["date"]);

                        $("#params-table").navGrid(
                            "#params-table-pager",
                            {   // buttons
                                edit: false,
                                add: false,
                                del: false,
                                search: true,
                                refresh: false,
                                view: false,
                            }, {}, {}, {},
                            {   // search
                                multipleGroup: true,
                                closeOnEscape: true,
                                multipleSearch: true,
                                closeAfterSearch: true,
                                showQuery: true,
                        });

                        formId.bind("resize", function() {
                            $("#params-table").setGridWidth(formId.width()-100, true);
                        }).trigger("resize");

                        $("#faces-table").jqGrid({
                            url: "/gridhandler/load/search",
                            datatype: "json",
                            mtype: "POST",
                            treeGrid: false,
                            colNames: {{.faces.ColNames}},
                            colModel: grid.SetPrimitive({{.faces.ColModel}}),
                            pager: "#faces-table-pager",
                            gridview: true,
                            viewrecords: true,
                            height: "100%",
                            width: "auto",
                            rowNum: 5,
                            rownumbers: true,
                            rownumWidth: 20,
                            rowList: [5, 10, 20, 50],
                            caption: {{.faces.Caption}},
                            sortname: "id",
                            sortorder: "asc",
                            loadError: function (jqXHR, textStatus, errorThrown) {
                                alert('HTTP status code: ' + jqXHR.status + '\n'
                                    + 'textStatus: ' + textStatus + '\n'
                                    + 'errorThrown: ' + errorThrown);
                                alert('HTTP message body: ' + jqXHR.responseText);
                            },
                            beforeRequest: function() {
                                $("#faces-table").setGridParam({ postData: {
                                    "filters": filter ? filter : null,
                                } });
                            },
                            onSelectRow: function(faceId) {
                                ansSelect.empty();
                                var fio = $($($("#faces-table").find('tr#'+faceId)[0]).find('td')[1]).text();
                                console.log("fio: ", fio);
                                var option = $("<option/>", { value: faceId, text:  fio })
                                ansSelect.append(option);
                            }
                        });

                        $("#faces-table").navGrid(
                            "#faces-table-pager",
                            {   // buttons
                                edit: false,
                                add: false,
                                del: false,
                                view: false,
                                search: false,
                                refresh: false,
                        });

                        formId.bind("resize", function() {
                            $("#faces-table").setGridWidth(formId.width()-100, true);
                        }).trigger("resize");
                    }

                },
                {   //del
                    closeAfterAdd: true,
                }
            );

            $("#"+subgrid_id + "_t").jqGrid("hideCol", ["group_id"]);

            $(window).bind("resize", function() {
                $("#"+subgrid_id + "_t").setGridWidth($("#my-group-table").width(), true);
            }).trigger("resize");
        }
    });

    $("#my-group-table").jqGrid("hideCol", ["face_id"]);

    $("#my-group-table").navGrid(
        "#my-group-table-pager",
        {
            edit: true,
            add: true,
            del: true,
            view: true,
            search: false,
            refresh: false,
        },
        {
            width: "100%",
            recreateForm: true,
            afterSubmit: function(data) { return utils.errTextFormat(data, "my-group-table"); },
            errorTextFormat: function(data) { return utils.errTextFormat(data, "my-group-table"); },
            afterShowForm: utils.resizeSelectWidth,
        },
        {
            width: "100%",
            recreateForm: true,
            addedrow: "last",
            afterSubmit: function(data) { return utils.errTextFormat(data, "my-group-table"); },
            errorTextFormat: function(data) { return utils.errTextFormat(data, "my-group-table"); },
            afterShowForm: utils.resizeSelectWidth,
            afterSubmit: function(data) {
                var ans = utils.errTextFormat(data, "my-group-table");
                window.location.reload();
                return ans;
            },
        },
        {
            afterSubmit: function(data) {
                var ans = utils.errTextFormat(data, "my-group-table");
                window.location.reload();
                return ans;
            },
        }
    );

    $("#my-group-table").jqGrid(
        "navButtonAdd",
        "#my-group-table-pager",
        {
            caption: "", buttonicon: "ui-icon-script", title: "Регистрация группы",
            onClickButton: function() { regGroup.Registration("dialog-reg-group", "my-group-table"); }
        }
    );

    $(window).bind("resize", function() {
        $("#my-group-table").setGridWidth($(window).width()-100, true);
    }).trigger("resize");

    $("#group-table").jqGrid({
        url: "/handler/"+{{.group.TableName}}.replace(/_/g, "")+"load",
        datatype: "json",
        mtype: "POST",
        colNames: {{.group.ColNames}},
        colModel: grid.SetPrimitive({{.group.ColModel}}),
        pager: "#group-table-pager",
        gridview: true,
        sortname: "id",
        viewrecords: true,
        height: "100%",
        width: "auto",
        rowNum: 5,
        rownumbers: true,
        rownumWidth: 20,
        rowList: [5, 10, 20, 50],
        caption: {{.group.Caption}},
        sortname: "id",
        sortorder: "asc",
        loadError: function (jqXHR, textStatus, errorThrown) {
            alert('HTTP status code: ' + jqXHR.status + '\n'
                + 'textStatus: ' + textStatus + '\n'
                + 'errorThrown: ' + errorThrown);
            alert('HTTP message body: ' + jqXHR.responseText);
        },

        subGrid: {{.group.Sub}},
        subGridOptions: {
            "plusicon": "ui-icon-triangle-1-e",
            "minusicon": "ui-icon-triangle-1-s",
            "openicon": "ui-icon-arrowreturn-1-e",
            "reloadOnExpand": true,
            "selectOnExpand": true
        },
        subGridRowExpanded: function(subgrid_id, group_id) {
            $("#" + subgrid_id).append("<table id='" + subgrid_id + "_t" + "' class='scroll'></table>"
                + "<div id='" + subgrid_id + "_p" + "' class='scroll'></div></br>");

            $("#" + subgrid_id + "_t").jqGrid({
                url: "/handler/"+{{.group.SubTableName}}.replace(/_/g, "")+"load/"+group_id,
                datatype: "json",
                mtype: "POST",
                colNames: {{.group.SubColNames}},
                colModel: grid.SetPrimitive({{.group.SubColModel}}),
                rowNum: 5,
                rowList: [5, 10, 20, 50],
                pager: "#" + subgrid_id + "_p",
                caption: {{.group.SubCaption}},
                sortname: "num",
                sortorder: "asc",
                height: "100%",
                width: $("#group-table").width()-65,
                loadError: function(jqXHR, textStatus, errorThrown) {
                    alert('HTTP status code: ' + jqXHR.status + '\n'
                        + 'textStatus: ' + textStatus + '\n'
                        + 'errorThrown: ' + errorThrown);
                    alert('HTTP message body: ' + jqXHR.responseText);
                },
            });

            $("#"+subgrid_id + "_t").navGrid(
                "#"+subgrid_id + "_p",
                {   //buttons
                    edit: false,
                    add: false,
                    del: false,
                    refresh: false,
                    view: true,
                    search: false
                }
            );

            $("#"+subgrid_id + "_t").jqGrid("hideCol", ["face_id"]);

            $(window).bind("resize", function() {
                $("#"+subgrid_id + "_t").setGridWidth($("#group-table").width(), true);
            }).trigger("resize");
        }
    });

    $("#group-table").jqGrid("hideCol", ["face_id"]);

    $(window).bind("resize", function() {
        $("#group-table").setGridWidth($(window).width()-100, true);
    }).trigger("resize");

    $("#reg-table").jqGrid({
        url: "/handler/"+{{.reg.TableName}}.replace(/_/g, "")+"load",
        datatype: "json",
        mtype: "POST",
        treeGrid: false,
        colNames: {{.reg.ColNames}},
        colModel: grid.SetPrimitive({{.reg.ColModel}}),
        pager: "#reg-table-pager",
        gridview: true,
        sortname: "id",
        viewrecords: true,
        height: "100%",
        width: "auto",
        rowNum: 5,
        rownumbers: true,
        rownumWidth: 20,
        rowList: [5, 10, 20, 50],
        caption: {{.reg.Caption}},
        sortname: "id",
        sortorder: "asc",
        multiselect: true,
        editurl: "/gridhandler/editgridrow/" + {{.reg.TableName}},
        loadError: function(jqXHR, textStatus, errorThrown) {
            alert('HTTP status code: ' + jqXHR.status + '\n'
                + 'textStatus: ' + textStatus + '\n'
                + 'errorThrown: ' + errorThrown);
            alert('HTTP message body: ' + jqXHR.responseText);
        },
    });

    $("#reg-table").jqGrid("hideCol", ["face_id"]);

    $("#reg-table").navGrid(
        "#reg-table-pager",
        {
            edit: false,
            add: false,
            del: false,
            refresh: false,
            view: false,
            search: false
        }
    );

    $("#reg-table").jqGrid(
        "navButtonAdd",
        "#reg-table-pager",
        {
            caption: "", buttonicon: "ui-icon-script", title: "Анкета",
            onClickButton: function() {
                var id = utils.getCurrRowId("reg-table");
                if (id == -1) return false;
                blank.ShowPersonBlank("dialog-person-request", id);
            }
        }
    );

    $(window).bind("resize", function() {
        $("#reg-table").setGridWidth($(window).width()-100, true);
    }).trigger("resize");

    $("#groupreg-table").jqGrid({
        url: "/handler/"+{{.groupreg.TableName}}.replace(/_/g, "")+"load",
        datatype: "json",
        mtype: "POST",
        treeGrid: false,
        colNames: {{.groupreg.ColNames}},
        colModel: grid.SetPrimitive({{.groupreg.ColModel}}),
        pager: "#groupreg-table-pager",
        gridview: true,
        sortname: "id",
        viewrecords: true,
        height: "100%",
        width: "auto",
        rowNum: 5,
        rownumbers: true,
        rownumWidth: 20,
        rowList: [5, 10, 20, 50],
        caption: {{.groupreg.Caption}},
        sortname: "id",
        sortorder: "asc",
        editurl: "/gridhandler/editgridrow/" + {{.groupreg.TableName}},
        loadError: function (jqXHR, textStatus, errorThrown) {
            alert('HTTP status code: ' + jqXHR.status + '\n'
                + 'textStatus: ' + textStatus + '\n'
                + 'errorThrown: ' + errorThrown);
            alert('HTTP message body: ' + jqXHR.responseText);
        },

        subGrid: {{.groupreg.Sub}},
        subGridOptions: {
            "plusicon": "ui-icon-triangle-1-e",
            "minusicon": "ui-icon-triangle-1-s",
            "openicon": "ui-icon-arrowreturn-1-e",
            "reloadOnExpand": true,
            "selectOnExpand": true
        },
        subGridRowExpanded: function(subgrid_id, row_id) {
            $("#" + subgrid_id).append("<table id='" + subgrid_id + "_t" + "' class='scroll'></table>"
                + "<div id='" + subgrid_id + "_p" + "' class='scroll'></div></br>");

            var group_id = $("#groupreg-table").jqGrid("getCell", row_id, "group_id");
            var event_id = $("#groupreg-table").jqGrid("getCell", row_id, "event_id");

            $("#" + subgrid_id + "_t").jqGrid({
                url: "/handler/"+{{.groupreg.SubTableName}}.replace(/_/g, "")+"load/"+group_id,
                datatype: "json",
                mtype: "POST",
                colNames: {{.groupreg.SubColNames}},
                colModel: grid.SetPrimitive({{.groupreg.SubColModel}}),
                rowNum: 5,
                rowList: [5, 10, 20, 50],
                pager: "#" + subgrid_id + "_p",
                caption: {{.groupreg.SubCaption}},
                sortname: "num",
                sortorder: "asc",
                height: "100%",
                width: $("#groupreg-table").width()-65,
                editurl: "/gridhandler/editgridrow/"+{{.groupreg.SubTableName}},
                loadError: function (jqXHR, textStatus, errorThrown) {
                    alert('HTTP status code: ' + jqXHR.status + '\n'
                        + 'textStatus: ' + textStatus + '\n'
                        + 'errorThrown: ' + errorThrown);
                    alert('HTTP message body: ' + jqXHR.responseText);
                },
            });

            $("#"+subgrid_id + "_t").navGrid(
                "#"+subgrid_id + "_p",
                {
                    edit: false,
                    add: false,
                    del: false,
                    refresh: false,
                    view: false,
                    search: false
                }
            );

            $("#"+subgrid_id + "_t").jqGrid(
                "navButtonAdd",
                "#"+subgrid_id + "_p",
                {
                    caption: "", buttonicon: "ui-icon-contact", title: "Редактировать анкету участника группы",
                    onClickButton: function() {
                        var person_id = $("#"+subgrid_id + "_t").jqGrid("getGridParam", "selrow");
                        blank.ShowPersonBlankFromGroup(row_id, person_id, "dialog-group-person-request");
                    }
                }
            );

            $("#"+subgrid_id + "_t").jqGrid("hideCol", ["group_id"]);
            $("#"+subgrid_id + "_t").jqGrid("hideCol", ["status"]);

            $(window).bind("resize", function() {
                $("#"+subgrid_id + "_t").setGridWidth($("#groupreg-table").width(), true);
            }).trigger("resize");
        }
    });

    $("#groupreg-table").jqGrid("hideCol", ["face_id"]);

    $("#groupreg-table").navGrid(
        "#groupreg-table-pager",
        {
            edit: false,
            add: false,
            del: false,
            refresh: false,
            view: false,
            search: false
        }
    );

    $(window).bind("resize", function() {
        $("#groupreg-table").setGridWidth($(window).width()-100, true);
    }).trigger("resize");

});

</script>

{{template "footer"}}
{{end}}
