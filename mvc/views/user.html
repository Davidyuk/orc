{{define "user"}}
{{template "header"}}

<div id="container">
    <div id="title" class="left"></div></br>
    <div id="server-answer" class="left"></div></br>
    <div id="cabinet" class="left">
        <form></form>
    </div>
</div>

<script type="text/javascript">
    $("#title").append("Личный кабинет <strong>{{.Caption}}</strong>");

    $("#cabinet, #logout-btn, #cabinet-btn").css("visibility", "visible");

    var valid = false;
    var data = {
        {{with .Table}}
            {{range $index, $elmt := .}}
                {{range $i, $v := $elmt}}
                    {{$i}}: {{$v}},
                {{end}}
            {{end}}
        {{end}}
    }

    function getFormData() {
        var result = $("form").serializeArray();
        return result;
    }

    require(["utils"],
    function(utils) {
        var id = data["id"];

        for (var i = 1; i < {{.Columns}}.length; ++i) {

            var lable = $("<label/>", {
                for: {{.Columns}}[i],
                id: "label-" + {{.Columns}}[i],
                text: {{.ColNames}}[i]
            });

            var input = $("<input/>", {
                    id: {{.Columns}}[i],
                    name: {{.Columns}}[i],
            }).val(data[{{.Columns}}[i]]);

            $("#cabinet form").append(lable).append(input);

            $("#" + {{.Columns}}[i]).blur(function() {
                if ($(this).val() != ""){
                    valid = true;
                    $(this).css({"border": "2px solid green"});
                } else {
                    valid = false;
                    $(this).css({"border": "2px solid red"});
                }
            });
        }

        $("</br>").appendTo("#cabinet form");
        $("<input/>", {
            id: "save-btn",
            name: "submit",
            type: "button",
            value: "Сохранить изменения",
        }).appendTo("#cabinet form");

        $("#save-btn").click(function() {
            var data = getFormData();
            utils.postRequest({
                    "action": "editProfile",
                    "id": id.toString(),
                    "data": data,
                    "table": "persons"
                },
                function() {
                    $("#cabinet").css("visibility", "hidden");
                    $("#server-answer").text("Изменения сохранены.").css("color", "green");
                }, "/handler");
        });
    });
</script>

{{template "footer"}}
{{end}}
