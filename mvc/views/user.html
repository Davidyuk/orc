{{define "user"}}
{{template "header"}}

<div id="container">
    <div id="title" class="left"></div></br>
    <div id="server-answer" class="left"></div></br>
    <div id="cabinet" class="left">
        <form></form>
    </div>
</div>

<script type="text/javascript">
    $("#title").append("Личный кабинет");
    var valid = false;
    var data = []

    {{with .Table}}
        {{range $index, $elmt := .}}
            var paragraph = []
            {{range $i, $v := $elmt}}
                paragraph.push({"id": {{$i}}, "val": {{$v}} }),
            {{end}}
            data.push(paragraph)
        {{end}}
    {{end}}

    function getFormData() {
        var result = $("form").serializeArray();
        return result;
    }

    require(["utils"],
    function(utils) {
        for (var i = 0; i < data.length; ++i) {

            var lable = $("<label/>", {
                for: data[i][0]["id"],
                id: "label-" + data[i][0]["id"],
                text: data[i][0]["val"]
            });

            var input = $("<input/>", {
                id: data[i][1]["id"],
                name: data[i][1]["id"],
            }).val(data[i][1]["val"]);

            $("#cabinet form").append(lable).append(input);

            $("#" + data[i]["name"]).blur(function() {
                if ($(this).val() != "") {
                    valid = true;
                    $(this).css({"border": "2px solid green"});
                } else {
                    valid = false;
                    $(this).css({"border": "2px solid red"});
                }
            });
        }

        $("</br>").appendTo("#cabinet form");
        $("<input/>", {
            id: "save-btn",
            name: "submit",
            type: "button",
            value: "Сохранить изменения",
        }).appendTo("#cabinet form");

        $("#save-btn").click(function() {
            var data = getFormData();
            utils.postRequest({
                    "action": "editProfile",
                    "id": id,
                    "data": data,
                    "table": "persons"
                },
                function() {
                    $("#cabinet").css("visibility", "hidden");
                    $("#server-answer").text("Изменения сохранены.").css("color", "green");
                }, "/handler");
        });
    });
</script>

{{template "footer"}}
{{end}}
